<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style>
    html,
    body,
    #map {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }
    .ufo{
        position: absolute;
    }

    .ufo svg {
        width: 60px;
        height: 20px;
        font: 10px sans-serif;
        position: absolute;
    }

</style>
<div id="map"></div>
<script src="//maps.google.com/maps/api/js?key=AIzaSyDeuqYAoD2lUBNikOZng7QsNOXhZ9-mH5o"></script>
<script src="//d3js.org/d3.v5.js"></script>
<script>
    async function googleMap() {
        // Create the Google Map…
        let map = new google.maps.Map(d3.select("#map").node(), {
            zoom: 4,
            center: {
                lat: 41.4925,
                lng: -95.8905556,
            },
            mapTypeId: 'roadmap',
            //Style made in the google API style wizard to give the map a UFO feel
            //You can customize your map styles and and them into a styles array in the options opbject
            styles: [{"elementType": "geometry","stylers": [{"color": "#212121"}]},
                    {"elementType": "labels.icon","stylers": [{"visibility": "off"}]},
                    {"elementType": "labels.text.fill","stylers": [{"color": "#757575"}]},
                    {"elementType": "labels.text.stroke","stylers": [{"color": "#212121"}]},
                    {"featureType": "administrative","elementType": "geometry","stylers": [{"color": "#757575"}]},
                    {"featureType": "administrative.country","elementType": "labels.text.fill","stylers": [{"color": "#9e9e9e"}]},
                    {"featureType": "administrative.land_parcel","stylers": [{"visibility": "off"}]},
                    {"featureType": "administrative.locality","elementType": "labels.text.fill","stylers": [{"color": "#bdbdbd"}]},
                    {"featureType": "administrative.neighborhood","stylers": [{"visibility": "off"}]},
                    {"featureType": "poi","elementType": "labels.text","stylers": [{"visibility": "off"}]},
                    {"featureType": "poi","elementType": "labels.text.fill","stylers": [{"color": "#757575"}]},
                    {"featureType": "poi.park","elementType": "geometry","stylers": [{"color": "#181818"}]},
                    {"featureType": "poi.park","elementType": "labels.text.fill","stylers": [{"color": "#616161"}]},
                    {"featureType": "poi.park","elementType": "labels.text.stroke","stylers": [{"color": "#1b1b1b"}]},
                    {"featureType": "road","elementType": "geometry.fill","stylers": [{"color": "#2c2c2c"}]},
                    {"featureType": "road","elementType": "labels","stylers": [{"visibility": "off"}]},
                    {"featureType": "road","elementType": "labels.text.fill","stylers": [{"color": "#8a8a8a"}]},
                    {"featureType": "road.arterial","elementType": "geometry","stylers": [{"color": "#373737"}]},
                    {"featureType": "road.highway","elementType": "geometry","stylers": [{"color": "#3c3c3c"}]},
                    {"featureType": "road.highway.controlled_access","elementType": "geometry","stylers": [{"color": "#4e4e4e"}]},
                    {"featureType": "road.local","elementType": "labels.text.fill","stylers": [{"color": "#616161"}]},
                    {"featureType": "transit","elementType": "labels.text.fill","stylers": [{"color": "#757575"}]},
                    {"featureType": "water","elementType": "geometry","stylers": [{"color": "#000000"}]},
                    {"featureType": "water","elementType": "labels.text","stylers": [{"visibility": "off"}]},
                    {"featureType": "water","elementType": "labels.text.fill","stylers": [{"color": "#3d3d3d"}]}
                    ]
        });

        // we downloaded ufo data from here: https://www.kaggle.com/NUFORC/ufo-sightings 
        //Thanks Kaggle!
      
        // Load the ufo sighting data. When the data comes back, create an overlay.
        let data = await d3.csv("ufo-sightings.csv");

        //Filter the data to only see US sightings. Take a sample of 200.
        let usDataSample = data.filter(d=> d.country === 'us').slice(0, 200);

        let overlay = new google.maps.OverlayView();

        // Add the container when the overlay is added to the map.
        overlay.onAdd = function () {

            //to see all the available panes;
            console.log(this.getPanes());
        
            let layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
                .attr("class", "ufo");

            overlay.onRemove = function () {
                d3.select('.ufo').remove();
            }

            overlay.draw = function () {

                let projection = this.getProjection(),
                    padding = 10;

                let circleScale = d3.scaleLinear()
                    .domain([d3.min(usDataSample, d=> d.duration), d3.max(usDataSample, d=> d.duration)])
                    .range([2, 7]).clamp(true);

                // Draw each marker as a separate SVG element.
                // We could use a single SVG, but what size would it have?
                let marker = layer.selectAll('svg')
                    .data(usDataSample);

                let markerEnter = marker.enter().append("svg");

                markerEnter.append("circle")
                    .attr("cx", padding)
                    .attr("cy", padding)
                    .style('opacity', .8);
                
                marker.exit().remove();

                marker = marker.merge(markerEnter);

                marker
                    .each(transform)
                    .attr("class", "marker");

                // Add a circle.
                marker.select("circle")
                    .attr("r", d=> circleScale(d.duration))
                    .attr('fill', d => {
                        return d.shape === 'fireball' ? '#FB7E01' : '#01FB86';
                    })
                .on('click',d=>console.log(d));

                //transforms the markers to the right lat / lng using the projection from google maps
                function transform(d) {
                    d = new google.maps.LatLng(+d.latitude, +d.longitude);
                    d = projection.fromLatLngToDivPixel(d);
                    return d3.select(this)
                        .style("left", (d.x - padding) + "px")
                        .style("top", (d.y - padding) + "px");
                }
               
            };
        };

        // Bind our overlay to the map…
        overlay.setMap(map);
    };

    googleMap();
</script>